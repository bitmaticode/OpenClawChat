# 2026-02-08

- Carlos pidió crear checklist de tareas pendientes para OpenClawChat:
  1) Campo en ajustes para configurar URL de gateway.
  2) Configurar GitHub para el proyecto.
  3) Nueva feature de TTS nativo de iOS.
  4) Revisar el envío de multimedia (fotos y ficheros).
  5) Autoconnect al cambiar de agente.
  6) Persistencia de mensajes.
  7) Añadir opciones con "/" estilo bot de Telegram.

## Proyecto: iOS OpenClawChat (resumen)

- Objetivo: app iOS para chatear con OpenClaw (WS gateway), con UX tipo chat y ajustes in-app.
- Directorio proyecto: `/Users/carlos/clawd-codex/OpenClawChat`

### Cambios/decisiones clave implementadas
- Gateway URL: se guarda en `AppStorage` (no secreto).
- Gateway token: se guarda en Keychain.
- Autoconexión al iniciar la app y al cambiar de agente (reconexión secuencial para evitar carreras disconnect/connect).
- Persistencia local de mensajes por `sessionKey` (JSON en Application Support).
- TTS streaming en iOS con buffer/segmentación (toggle en settings; parar al desconectar/cambiar agente).
- Comandos "/" estilo Telegram: `/help`, `/agent`, `/clear`, `/reconnect`, `/tts on|off`.
- UX: markdown (evitar parse mientras streaming), "escribiendo…", botón stop (abort), autoscroll + botón bajar.
- Envío/preview de imágenes: encoder JPEG (normaliza orientación + resize + compresión), store local de adjuntos + render en burbuja.

### Deploy a iPhone
- Instalación/launch por cable y por Wi-Fi usando `xcrun devicectl`.
- Wi-Fi puede fallar si el iPhone está bloqueado o "busy/preparing".

### GitHub
- Repo creado/subido (cuenta bitmaticode): `https://github.com/bitmaticode/OpenClawChat`
- Export "limpio" en `/Users/carlos/clawd-codex/github-export/openclawchat-ios` para evitar subir cosas sensibles del workspace.
- Claves SSH creadas y autenticación verificada.

### Hallazgo importante: límite de tamaño en imágenes por WS
- El gateway WS anuncia `policy.maxPayload = 512KB`.
- Como las imágenes van inline en `chat.send` dentro de JSON + base64, se supera fácil el límite.
- Cuando pasa, el gateway cierra el socket con **close code 1009** (message too big) y en iOS aparece como **"Gateway disconnected"**.
- Acción futura: ajustar `ImageUploadEncoder`/pipeline para quedar muy por debajo del límite (≈300KB) o mostrar error antes de enviar.

### TTS fix
- AVAudioSession configurada en `.playback` + `.spokenAudio` + `.duckOthers` para que suene con mute.
- Voz seleccionada explícitamente: **Marisol (Premium)** si instalada, fallback es-ES.
- Rama `tts-local-review` mergeada a main (commit `03fd4ef`).

### App icon
- Logo proporcionado por Carlos tenía borde negro → crop con ffmpeg cropdetect.
- Assets generados para todas las tallas iPhone + 1024x1024 en `AppIcon.appiconset`.

### STT local con Whisper (rama `stt-whisper-local`)
- Motor: **whisper.cpp** vía SPM (`ggerganov/whisper.spm`, branch master).
- Modelo: `whisper-large-v3-turbo-q4_k.gguf` (~454 MB) de HuggingFace.
- Descarga automática en primer uso, guardado en `Application Support/openclaw/models/`.
- **Implementación v1** (commit `f7d9474`): AVAudioRecorder, grabar→parar→transcribir, resultado al draft.
- **Implementación v2 - Realtime** (commit `aa19742`): Carlos pidió transcripción en tiempo real.
  - `AVAudioEngine` + tap de audio → buffer 16kHz PCM float.
  - Transcripción periódica (~0.6s) mientras habla, frase a frase al draft.
  - VAD ligero por RMS (threshold 0.015).
  - Auto-envío al gateway tras **1.5s de silencio**.
  - Toggle micrófono: 1º toque = escuchar, 2º toque = parar (envía pendiente).
  - Idioma fijo: español (`"es"`).
  - Threading: bufferQueue serial para estado compartido, transcripción en global queue, callbacks en main.
  - `AVAudioSession` configurada como `.playAndRecord` con `.defaultToSpeaker` + `.allowBluetooth`.
- Desplegada en iPhone para pruebas (19:31).
- Pendiente: feedback de Carlos sobre latencia/cortes/calidad.
